-- 1
SELECT t.ИД, v.ДАТА
FROM Н_ТИПЫ_ВЕДОМОСТЕЙ t
RIGHT JOIN Н_ВЕДОМОСТИ v ON t.ИД = v.ТВ_ИД
WHERE t.НАИМЕНОВАНИЕ < 'Экзаменационный лист'
  AND v.ДАТА > DATE '2022-06-08'
  AND v.ДАТА < DATE '1998-01-05';

-- 2
SELECT Н_ЛЮДИ.ИМЯ, Н_ОБУЧЕНИЯ.НЗК, Н_УЧЕНИКИ.ГРУППА
FROM Н_ЛЮДИ
INNER JOIN Н_ОБУЧЕНИЯ ON Н_ЛЮДИ.ИД = Н_ОБУЧЕНИЯ.ЧЛВК_ИД
INNER JOIN Н_УЧЕНИКИ ON Н_ОБУЧЕНИЯ.ЧЛВК_ИД = Н_УЧЕНИКИ.ЧЛВК_ИД
WHERE Н_ЛЮДИ.ОТЧЕСТВО = 'Александрович'
  AND Н_ОБУЧЕНИЯ.ЧЛВК_ИД = 163276;

-- 3 НАВЕРНОЕ ТАК
SELECT COUNT(*)
FROM(
	SELECT ДАТА
	FROM Н_ВЕДОМОСТИ
	GROUP BY ДАТА
);

-- 4
SELECT
    Л.ФАМИЛИЯ,
    COUNT(*)
FROM Н_ЛЮДИ Л
WHERE Л.ФАМИЛИЯ IN (
    SELECT
        Л.ФАМИЛИЯ
    FROM Н_ЛЮДИ Л
    LEFT JOIN Н_УЧЕНИКИ У ON Л.ИД = У.ЧЛВК_ИД
    WHERE У.ЧЛВК_ИД IS NULL
    GROUP BY Л.ФАМИЛИЯ
    HAVING COUNT(*) = 10
)
GROUP BY Л.ФАМИЛИЯ;

-- 5
SELECT 
    Л.ИД AS Номер,
    (Л.ФАМИЛИЯ || ' ' || Л.ИМЯ || ' ' || Л.ОТЧЕСТВО) AS ФИО,
    AVG(CAST(В.ОЦЕНКА AS numeric)) AS Ср_оценка
FROM Н_УЧЕНИКИ AS У
JOIN Н_ЛЮДИ AS Л ON У.ЧЛВК_ИД = Л.ИД
JOIN Н_ВЕДОМОСТИ AS В ON Л.ИД = В.ЧЛВК_ИД
WHERE В.ОЦЕНКА ~ '^\d+$'
GROUP BY Л.ИД, Л.ФАМИЛИЯ, Л.ИМЯ, Л.ОТЧЕСТВО
HAVING AVG(CAST(В.ОЦЕНКА AS numeric)) <= (
    SELECT MAX(CAST(В.ОЦЕНКА AS numeric))
    FROM Н_УЧЕНИКИ AS У
    JOIN Н_ЛЮДИ AS Л ON У.ЧЛВК_ИД = Л.ИД
    JOIN Н_ВЕДОМОСТИ AS В ON Л.ИД = В.ЧЛВК_ИД
    WHERE У.ГРУППА = '1101' AND В.ОЦЕНКА ~ '^\d+$'
);

-- 6
SELECT Н_УЧЕНИКИ.ГРУППА,
	Н_ЛЮДИ.ИД,
	Н_ЛЮДИ.ФАМИЛИЯ,
	Н_ЛЮДИ.ИМЯ,
	Н_ЛЮДИ.ОТЧЕСТВО,
	Н_УЧЕНИКИ.ИД AS НОМЕР_ПРИКАЗА,
	Н_УЧЕНИКИ.СОСТОЯНИЕ
FROM Н_УЧЕНИКИ
JOIN Н_ЛЮДИ ON Н_УЧЕНИКИ.ЧЛВК_ИД = Н_ЛЮДИ.ИД
JOIN Н_ПЛАНЫ ON Н_УЧЕНИКИ.ПЛАН_ИД = Н_ПЛАНЫ.ИД
JOIN Н_ФОРМЫ_ОБУЧЕНИЯ ON Н_ПЛАНЫ.ФО_ИД = Н_ФОРМЫ_ОБУЧЕНИЯ.ИД
WHERE Н_УЧЕНИКИ.НАЧАЛО >= DATE '2012-09-01' AND Н_ПЛАНЫ.КУРС = 1 AND Н_ФОРМЫ_ОБУЧЕНИЯ.НАИМЕНОВАНИЕ = 'Очная';

-- 7
SELECT COUNT(*)
FROM (
    SELECT Н_УЧЕНИКИ.ЧЛВК_ИД
    FROM Н_УЧЕНИКИ
    JOIN Н_ВЕДОМОСТИ ON Н_УЧЕНИКИ.ЧЛВК_ИД = Н_ВЕДОМОСТИ.ЧЛВК_ИД
    WHERE Н_УЧЕНИКИ.ГРУППА = '3100' AND Н_ВЕДОМОСТИ.БУКВА = 'B'
    GROUP BY Н_УЧЕНИКИ.ЧЛВК_ИД
);

-- все отличники, кому на этап "отличничества" было 20 лет
SELECT (Л.ФАМИЛИЯ || ' ' || Л.ИМЯ || ' ' || Л.ОТЧЕСТВО) AS ФИО
FROM Н_ЛЮДИ AS Л
JOIN (
    SELECT Л.ИД
    FROM Н_ЛЮДИ AS Л
    JOIN Н_УЧЕНИКИ AS У ON У.ЧЛВК_ИД = Л.ИД
    JOIN Н_ВЕДОМОСТИ AS В ON В.ЧЛВК_ИД = У.ЧЛВК_ИД
    WHERE В.БУКВА = 'A' AND DATE_PART('year', AGE(В.ДАТА, Л.ДАТА_РОЖДЕНИЯ)) = 20
    GROUP BY Л.ИД
) AS ИДЫ ON ИДЫ.ИД = Л.ИД;
