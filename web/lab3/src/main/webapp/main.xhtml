<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui">


<h:head>
    <title>Главная страница</title>
    <style>
        body {
            font-family: sans-serif;
            color: black;
        }
        #header {
            font-family: monospace;
            color: blue;
            font-size: 18px;
            margin-bottom: 2%;
        }

        .container {
            display: flex;
        }

        #graph {
            width: 50%;
            height: 100%;
            margin: 20px;
        }

        #rightPart {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start; // чтобы не прижималось вправо
            padding: 20px;
            box-sizing: border-box;
        }

        .box {
            padding: 20px;
            background: #fff;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            display: flex;
            flex-direction: row;
            gap: 15px;
        }

        .group.vertical {
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        input, select, button {
            margin: 2%;
            padding: 1%;
        }

        button:hover {
            background-color: lightblue;
        }

        tbody {
            font-family: monospace;
            color: black;
            font-size: 18px;
            border: 3px solid;
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            padding: 10px;
            border: 1px solid black;
            text-align: center;
        }
        #returnForm{
            text-align: center;
            margin-top: 30px;
            padding: 20px;
        }

    </style>
</h:head>

<h:body>

    <div class="container">
        <div id="leftPart">
            <!-- Динамически обновляемую картинку, изображающую
                область на координатной плоскости в соответствии с
                номером варианта и точки, координаты которых были заданы
                пользователем. Клик по картинке должен инициировать сценарий,
                осуществляющий определение координат новой точки и отправку
                их на сервер для проверки её попадания в область. Цвет точек
                должен зависить от факта попадания / непопадания в область.
                Смена радиуса также должна инициировать перерисовку картинки. -->
            <h:form id="canvasForm">
                <canvas id="graph" height="500" width="500" style="border:1px solid black; height: 500px; width: 500px;"></canvas>

                    <h:inputHidden id="xCanvas" value="#{pointBean.x}" />
                    <h:inputHidden id="yCanvas" value="#{pointBean.y}" />
                    <h:inputHidden id="rCanvas" value="#{pointBean.r}" />

                    <h:commandButton id="canvasSubmit"
                                     style="display:none"
                                     action="#{pointBean.submit}">
                        <f:ajax execute="@form" render="inputForm:resultsTable inputForm:pointsScript" />
                    </h:commandButton>
                <script>
                    //<![CDATA[
                        const canvas = document.getElementById('graph');
                        const ctx = canvas.getContext('2d');

                        const width = canvas.width;
                        const height = canvas.height;

                        let fakeR = false;


                        function drawPoint(x, y, r) {
                            let cx = canvas.width / 2;
                            let cy = canvas.height / 2;
                            let scale = (cx - 25) / r;

                            if ((x <= 0 && y <= 0 && y >= -x - r) ||
                                (x >= 0 && y >= 0 && x <= r && y <= r / 2) ||
                                (x >= 0 && y <= 0 && (x * x + y * y <= r * r / 4))) {
                                ctx.fillStyle = 'green';
                            } else {
                                ctx.fillStyle = 'red';
                            }

                            ctx.beginPath();
                            ctx.arc(cx + scale * x, cy - scale * y, 5, 0, Math.PI * 2, true);
                            ctx.fill();
                            ctx.closePath();
                        }


                        function handleCanvasClick(event){
                            let rect = canvas.getBoundingClientRect();

                            let cx = canvas.width / 2;
                            let cy = canvas.height / 2;

                            let clickX = (event.clientX - rect.left)/((rect.right-rect.left)/2)*cx;
                            let clickY = (event.clientY - rect.top)/((rect.bottom-rect.top)/2)*cy;

                            let r = parseFloat(document.getElementById("inputForm:r").value);

                            if (fakeR) {
                                alert("Сначала выберите значение r!");
                                return;
                            }

                            let scale = (cx-25)/r;
                            let x = (clickX - cx) / scale;
                            let y = (cy - clickY) / scale;

                            // Округлим на всякий
                            let xRounded = Math.round(x * 100) / 100;
                            let yRounded = Math.round(y * 100) / 100;

                            // рисуем-с
                            drawPoint(xRounded, yRounded, r);

                            // заполняем форму
                            var form = document.getElementById("canvasForm");
                            form["canvasForm:xCanvas"].value = xRounded;
                            form["canvasForm:yCanvas"].value = yRounded;
                            form["canvasForm:rCanvas"].value = r;

                            // и отправляем
                            document.getElementById("canvasForm:canvasSubmit").click();
                        }

                        function updateGraph(R) {
                            let cx = canvas.width / 2;
                            let cy = canvas.height / 2;
                            R = Number(R);
                            fakeR = false;
                            if (isNaN(R)){
                                R = 1;
                                fakeR = true;
                            }
                            let scale = (cx-25)/R;
                            ctx.clearRect(0, 0, width, height);
                            ctx.strokeStyle = 'black';
                            ctx.lineWidth = 1;
                            ctx.closePath();
                            ctx.fillStyle = 'blue';
                            // Треугольник
                            ctx.beginPath();
                            ctx.moveTo(cx, cy);
                            ctx.lineTo(cx-R*scale, cy);
                            ctx.lineTo(cx, cy+R*scale);
                            ctx.closePath();
                            ctx.fill();
                            // квадрат
                            ctx.fillRect(cx, cy, R*scale, -R/2*scale);
                            // четверть-круг
                            ctx.beginPath();
                            ctx.arc(cx, cy, R/2*scale, 0, Math.PI/2, false);
                            ctx.lineTo(cx, cy);
                            ctx.fill();
                            ctx.closePath();
                            // Оси
                            ctx.beginPath();
                            ctx.moveTo(0, cy);
                            ctx.lineTo(width, cy); // X
                            ctx.moveTo(cx, 0);
                            ctx.lineTo(cy, height); // Y
                            ctx.stroke();
                            // Деления шкалы
                            ctx.fillStyle = 'black';
                            if (fakeR){
                                for(let i=-2*R; i<=2*R; i++) {
                                    if(i===0) continue;
                                    ctx.fillRect(cx + i*scale/2 - 1, cy - 3, 2, 6);
                                    ctx.fillRect(cx - 3, cy - i*scale/2 - 1, 6, 2);
                                    ctx.fillText(i/2+"R", cx + i*scale/2 - 10, cy + 15);
                                    ctx.fillText(i/2+"R", cx + 10, cy - i*scale/2 + 3);
                                }
                            }
                            else{
                                for(let i=-2*R; i<2*R; i++) {
                                    if(i===0) continue;
                                    ctx.fillRect(cx + i*scale/2 - 1, cy - 3, 2, 6);
                                    ctx.fillRect(cx - 3, cy - i*scale/2 - 1, 6, 2);
                                    ctx.fillText(i/2, cx + i*scale/2 - 10, cy + 15);
                                    ctx.fillText(i/2, cx + 10, cy - i*scale/2 + 3);
                                }
                            }
                        }

                        updateGraph();
                        canvas.addEventListener("click", handleCanvasClick);

                        function handleAjaxForPoint(data) {

                            if (data.status === "success") {
                                var form = document.getElementById("inputForm");
                                var x = parseFloat(form["inputForm:x"].value);
                                var y = parseFloat(form["inputForm:y"].value);
                                var r = parseFloat(form["inputForm:rHidden"].value);
                                console.log("x:", x, "y:", y, "r:", r);
                                if (!isNaN(x) && !isNaN(y) && !isNaN(r)) {
                                    drawPoint(x, y, r);
                                }
                            }
                        }


                    //]]>
                </script>

            </h:form>
            <!-- Ссылку, позволяющую вернуться на стартовую страницу. -->
            <h:form id="returnForm">
                <h:link value="Вернуться на стартовую страницу"
                        outcome="toIndex"
                        style="padding:10px 20px; font-size:16px;" />
            </h:form>
        </div>
        <!--Набор компонентов для задания координат точки и
        радиуса области в соответствии с вариантом задания.
        Может потребоваться использование дополнительных библиотек
        компонентов - ICEfaces (префикс "ace") и PrimeFaces (префикс "p").
        Если компонент допускает ввод заведомо некорректных данных
        (таких, например, как буквы в координатах точки или отрицательный радиус),
        то приложение должно осуществлять их валидацию. -->

        <div id="rightPart">
            <h:form id="inputForm">

                <!-- X: selectOneRadio -->
                <h:panelGroup>
                    <h:outputLabel for="x" value="X:" />
                    <h:selectOneRadio id="x"
                                      value="#{pointBean.x}"
                                      required="true"
                                      requiredMessage="Выберите X">
                        <f:selectItem itemLabel="-4" itemValue="-4" />
                        <f:selectItem itemLabel="-3" itemValue="-3" />
                        <f:selectItem itemLabel="-2" itemValue="-2" />
                        <f:selectItem itemLabel="-1"  itemValue="-1" />
                        <f:selectItem itemLabel="0"  itemValue="0" />
                        <f:selectItem itemLabel="1"  itemValue="1" />
                        <f:selectItem itemLabel="2"  itemValue="2" />
                        <f:selectItem itemLabel="3"  itemValue="3" />
                        <f:selectItem itemLabel="4"  itemValue="4" />
                    </h:selectOneRadio>

                </h:panelGroup>

                <!-- Y: inputText с валидацией -->
                <h:panelGroup style="margin-top:10px">
                    <h:outputLabel for="y" value="Y:" />
                    <h:inputText id="y"
                                 value="#{pointBean.y}"
                                 required="true"
                                 requiredMessage="Введите Y (от -3 до 3)">
                        <f:validateDoubleRange minimum="-3" maximum="3" />
                    </h:inputText>

                </h:panelGroup>
                <br/>

                <!-- R: primefaces slider -->
                <h:panelGroup style="margin-top:10px">
                    <h:outputLabel value="R:" />
                    <!-- Для хранения R -->
                    <h:inputHidden id="rHidden" value="#{pointBean.r}" />

                    <!-- Слайдер -->
                    <p:slider for="rHidden"
                              minValue="2"
                              maxValue="5"
                              step="0.25"
                              onSlide="updateGraph(ui.value)"
                    />

                    <h:inputText id="r"
                                 value="#{pointBean.r}"
                                 readonly="true"
                                 style="width:50px; text-align:center; margin-left:5px;"

                    />
                </h:panelGroup>

                <!-- Кнопка отправки -->
                <h:commandButton value="Проверить"
                                 id="submitBtn"
                                 action="#{pointBean.submit}"
                                 style="margin-top:15px">
                    <f:ajax execute="@form" render="resultsTable yMsg"
                            onevent="handleAjaxForPoint"/>
                </h:commandButton>

                <!-- Таблица со списком результатов предыдущих проверок. -->

                <h:dataTable id="resultsTable"
                             value="#{resultsBean.results}"
                             var="res"
                             styleClass="results-table">

                    <h:column>
                        <f:facet name="header">X</f:facet>
                        <h:outputText value="#{res.x}" />
                    </h:column>

                    <h:column>
                        <f:facet name="header">Y</f:facet>
                        <h:outputText value="#{res.y}" />
                    </h:column>

                    <h:column>
                        <f:facet name="header">R</f:facet>
                        <h:outputText value="#{res.r}" />
                    </h:column>

                    <h:column>
                        <f:facet name="header">Попадание</f:facet>
                        <h:outputText value="#{res.hit ? 'Да' : 'Нет'}" />
                    </h:column>

                    <h:column>
                        <f:facet name="header">Время сервера</f:facet>
                        <h:outputText value="#{res.serverTime}">
                            <f:convertDateTime pattern="HH:mm:ss dd.MM.yyyy" />
                        </h:outputText>
                    </h:column>

                    <h:column>
                        <f:facet name="header">Время обработки, мс</f:facet>
                        <h:outputText value="#{res.processingTime}" />
                    </h:column>

                </h:dataTable>

            </h:form>

            </div>

        </div>

</h:body>
</html>
